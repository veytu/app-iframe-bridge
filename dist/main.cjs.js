"use strict";var oe=Object.defineProperty,ae=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable;var V=(t,e,r)=>e in t?oe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,D=(t,e)=>{for(var r in e||(e={}))ce.call(e,r)&&V(t,r,e[r]);if(K)for(var r of K(e))ue.call(e,r)&&V(t,r,e[r]);return t},_=(t,e)=>ae(t,de(e));Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var le=require("@netless/window-manager");const fe="!#%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",ge=87,pe=20,F=[],he=()=>{for(let t=0;t<pe;t++)F[t]=fe.charAt(Math.random()*ge);return F.join("")};function te(t){try{return t()}catch(e){console.error(e)}}class be{constructor(){this.push=this.addDisposer,this.disposers=new Map}addDisposer(e,r=this.genUID()){return this.flush(r),this.disposers.set(r,Array.isArray(e)?ye(e):e),r}add(e,r=this.genUID()){const s=e();return s?this.addDisposer(s,r):r}addEventListener(e,r,s,i,l=this.genUID()){return e.addEventListener(r,s,i),this.addDisposer(()=>e.removeEventListener(r,s,i),l),l}setTimeout(e,r,s=this.genUID()){const i=window.setTimeout(()=>{this.remove(s),e()},r);return this.addDisposer(()=>window.clearTimeout(i),s)}setInterval(e,r,s=this.genUID()){const i=window.setInterval(e,r);return this.addDisposer(()=>window.clearInterval(i),s)}remove(e){const r=this.disposers.get(e);return this.disposers.delete(e),r}flush(e){const r=this.remove(e);r&&r()}flushAll(){this.disposers.forEach(te),this.disposers.clear()}genUID(){let e;do e=he();while(this.disposers.has(e));return e}}function ye(t){return()=>t.forEach(te)}function me(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}function we(t,e){let r=t.getAttributes();if(r||(t.setAttributes(e),r=t.getAttributes()),!r)throw new Error("[NetlessAppMonaco] No attributes");return me(e)&&Object.keys(e).forEach(s=>{Object.prototype.hasOwnProperty.call(r,s)||t.updateAttributes([s],e[s])}),r}const b=new WeakMap,C=new WeakMap,A=new WeakMap,U=Symbol("anyProducer"),X=Promise.resolve(),O=Symbol("listenerAdded"),I=Symbol("listenerRemoved");let T=!1;function w(t){if(typeof t!="string"&&typeof t!="symbol")throw new TypeError("eventName must be a string or a symbol")}function R(t){if(typeof t!="function")throw new TypeError("listener must be a function")}function S(t,e){const r=C.get(t);return r.has(e)||r.set(e,new Set),r.get(e)}function E(t,e){const r=typeof e=="string"||typeof e=="symbol"?e:U,s=A.get(t);return s.has(r)||s.set(r,new Set),s.get(r)}function Se(t,e,r){const s=A.get(t);if(s.has(e))for(const i of s.get(e))i.enqueue(r);if(s.has(U)){const i=Promise.all([e,r]);for(const l of s.get(U))l.enqueue(i)}}function Q(t,e){e=Array.isArray(e)?e:[e];let r=!1,s=()=>{},i=[];const l={enqueue(n){i.push(n),s()},finish(){r=!0,s()}};for(const n of e)E(t,n).add(l);return{async next(){return i?i.length===0?r?(i=void 0,this.next()):(await new Promise(n=>{s=n}),this.next()):{done:!1,value:await i.shift()}:{done:!0}},async return(n){i=void 0;for(const c of e)E(t,c).delete(l);return s(),arguments.length>0?{done:!0,value:await n}:{done:!0}},[Symbol.asyncIterator](){return this}}}function Y(t){if(t===void 0)return Z;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");for(const e of t)if(!Z.includes(e))throw typeof e!="string"?new TypeError("`methodNames` element must be a string"):new Error(`${e} is not Emittery method`);return t}const j=t=>t===O||t===I;class y{static mixin(e,r){return r=Y(r),s=>{if(typeof s!="function")throw new TypeError("`target` must be function");for(const n of r)if(s.prototype[n]!==void 0)throw new Error(`The property \`${n}\` already exists on \`target\``);function i(){return Object.defineProperty(this,e,{enumerable:!1,value:new y}),this[e]}Object.defineProperty(s.prototype,e,{enumerable:!1,get:i});const l=n=>function(...c){return this[e][n](...c)};for(const n of r)Object.defineProperty(s.prototype,n,{enumerable:!1,value:l(n)});return s}}static get isDebugEnabled(){if(typeof process!="object")return T;const{env:e}=process||{env:{}};return e.DEBUG==="emittery"||e.DEBUG==="*"||T}static set isDebugEnabled(e){T=e}constructor(e={}){b.set(this,new Set),C.set(this,new Map),A.set(this,new Map),this.debug=e.debug||{},this.debug.enabled===void 0&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(r,s,i,l)=>{l=JSON.stringify(l),typeof i=="symbol"&&(i=i.toString());const n=new Date,c=`${n.getHours()}:${n.getMinutes()}:${n.getSeconds()}.${n.getMilliseconds()}`;console.log(`[${c}][emittery:${r}][${s}] Event Name: ${i}
	data: ${l}`)})}logIfDebugEnabled(e,r,s){(y.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,r,s)}on(e,r){R(r),e=Array.isArray(e)?e:[e];for(const s of e)w(s),S(this,s).add(r),this.logIfDebugEnabled("subscribe",s,void 0),j(s)||this.emit(O,{eventName:s,listener:r});return this.off.bind(this,e,r)}off(e,r){R(r),e=Array.isArray(e)?e:[e];for(const s of e)w(s),S(this,s).delete(r),this.logIfDebugEnabled("unsubscribe",s,void 0),j(s)||this.emit(I,{eventName:s,listener:r})}once(e){return new Promise(r=>{const s=this.on(e,i=>{s(),r(i)})})}events(e){e=Array.isArray(e)?e:[e];for(const r of e)w(r);return Q(this,e)}async emit(e,r){w(e),this.logIfDebugEnabled("emit",e,r),Se(this,e,r);const s=S(this,e),i=b.get(this),l=[...s],n=j(e)?[]:[...i];await X,await Promise.all([...l.map(async c=>{if(s.has(c))return c(r)}),...n.map(async c=>{if(i.has(c))return c(e,r)})])}async emitSerial(e,r){w(e),this.logIfDebugEnabled("emitSerial",e,r);const s=S(this,e),i=b.get(this),l=[...s],n=[...i];await X;for(const c of l)s.has(c)&&await c(r);for(const c of n)i.has(c)&&await c(e,r)}onAny(e){return R(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),b.get(this).add(e),this.emit(O,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return Q(this)}offAny(e){R(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(I,{listener:e}),b.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const r of e)if(this.logIfDebugEnabled("clear",r,void 0),typeof r=="string"||typeof r=="symbol"){S(this,r).clear();const s=E(this,r);for(const i of s)i.finish();s.clear()}else{b.get(this).clear();for(const s of C.get(this).values())s.clear();for(const s of A.get(this).values()){for(const i of s)i.finish();s.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let r=0;for(const s of e){if(typeof s=="string"){r+=b.get(this).size+S(this,s).size+E(this,s).size+E(this).size;continue}typeof s!="undefined"&&w(s),r+=b.get(this).size;for(const i of C.get(this).values())r+=i.size;for(const i of A.get(this).values())r+=i.size}return r}bindMethods(e,r){if(typeof e!="object"||e===null)throw new TypeError("`target` must be an object");r=Y(r);for(const s of r){if(e[s]!==void 0)throw new Error(`The property \`${s}\` already exists on \`target\``);Object.defineProperty(e,s,{enumerable:!1,value:this[s].bind(this)})}}}const Z=Object.getOwnPropertyNames(y.prototype).filter(t=>t!=="constructor");Object.defineProperty(y,"listenerAdded",{value:O,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(y,"listenerRemoved",{value:I,writable:!1,enumerable:!0,configurable:!1});var Ae=y;function N(t,e,r){return{sceneState:{sceneName:`${t}`,scenePath:`${r}/${t}`,contextPath:r,scenes:re(e),index:t-1}}}function re(t){const e=[];for(let r=1;r<=t;++r)e.push({name:String(r)});return e}function Ee(t){return Math.max(1,t-1)}function Me(t,e){return Math.min(e,t+1)}const ve=350;var u=(t=>(t.Init="Init",t.AttributesUpdate="AttributesUpdate",t.SetAttributes="SetAttributes",t.RegisterMagixEvent="RegisterMagixEvent",t.RemoveMagixEvent="RemoveMagixEvent",t.RemoveAllMagixEvent="RemoveAllMagixEvent",t.RoomStateChanged="RoomStateChanged",t.DispatchMagixEvent="DispatchMagixEvent",t.ReceiveMagixEvent="ReciveMagixEvent",t.NextPage="NextPage",t.PrevPage="PrevPage",t.SDKCreate="SDKCreate",t.OnCreate="OnCreate",t.SetPage="SetPage",t.GetAttributes="GetAttributes",t.Ready="Ready",t.Destroy="Destory",t.StartCreate="StartCreate",t.WrapperDidUpdate="WrapperDidUpdate",t.DisplayIframe="DisplayIframe",t.HideIframe="HideIframe",t.PageTo="PageTo",t))(u||{}),se=(t=>(t.WrapperDidMount="WrapperDidMount",t.IframeLoad="IframeLoad",t))(se||{});function Pe(t){var f;const e=t.getRoom(),r=t.getDisplayer(),s=r.observerId,i=(f=r.state.roomMembers.find($=>$.memberId===s))==null?void 0:f.payload,l=(i==null?void 0:i.uid)||(e==null?void 0:e.uid)||"",n=(i==null?void 0:i.nickName)||l,c=(i==null?void 0:i.userId)||l,g=(i==null?void 0:i.cursorName)||n||"";return{memberId:s,uid:l,userId:c,nickName:n,cursorName:g}}var ee;const M=(ee=window.navigator)==null?void 0:ee.userAgent;M==null||M.match(/(Edge?)\/(\d+)/);const ke=()=>typeof navigator!="undefined"&&typeof window!="undefined"&&/iPad|iPhone|iPod/.test(M),De=()=>typeof navigator!="undefined"&&/Android/.test(M),Re=new Set(["clicker","selector"]),Ce={kind:"IframeBridge",setup(t){const e=t.getBox(),r=t.getView(),s=t.getDisplayer(),i=t.getRoom(),{uid:l}=Pe(t),n=we(t,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,maxPage:0}),c=new be,g=document.createElement("div");Object.assign(g.style,{width:"100%",height:"100%",position:"relative"});const f=document.createElement("iframe");if(Object.assign(f.style,{width:"100%",height:"100%",border:"none",display:"block"}),g.appendChild(f),(t.storage.state.uid===l?0:2)==0){const a=document.createElement("button");Object.assign(a.style,{position:"absolute",right:"10px",top:"10px",zIndex:1e3,background:"white",border:"none",borderRadius:"100%",width:"30px",height:"30px",boxShadow:"0 20px 25px -5px #0000001a, 0 8px 10px -6px #0000001a"}),a.innerHTML="X",g.appendChild(a),a.onclick=function(d){d.preventDefault(),d.stopPropagation(),e._delegateEvents.emit("close")}}e.mountContent(g);let x=()=>{};const W=a=>ke()||De()||le.WindowManager.appReadonly?!1:Re.has(a);if(r){const a=document.createElement("div");Object.assign(a.style,{width:"100%",height:"100%",position:"absolute",top:0,left:0,overflow:"hidden"}),g.appendChild(a),t.mountView(a),r.disableCameraTransform=!0,c.add(()=>{const d=()=>{const k=g.getBoundingClientRect().height/ve;r.moveCamera({scale:k,animationMode:"immediately"})},o=new ResizeObserver(d);return o.observe(g),()=>o.disconnect()}),x=d=>{a.style.pointerEvents=d?"none":"auto"},x(W(i==null?void 0:i.state.memberState.currentApplianceName))}const L=a=>_(D({},a),{url:n.src,displaySceneDir:n.displaySceneDir,width:f.scrollWidth,height:f.scrollHeight,useClicker:!0,lastEvent:n.lastEvent}),m=new Ae,v=new Map,B=()=>{v.forEach((a,d)=>{s.removeMagixEventListener(d,a)}),v.clear()},z=(...a)=>!1,p=a=>{var d;z("[IframeBridge] postMessage %s %O",a.kind,a.payload),(d=f.contentWindow)==null||d.postMessage(JSON.parse(JSON.stringify(a)),"*")},P=(a,d)=>{t.getIsWritable()&&(t.updateAttributes(["lastEvent"],{name:a,payload:d}),i==null||i.dispatchMagixEvent(a,d))},G=()=>{p({kind:u.Init,payload:{attributes:L(n.state),roomState:s.state,currentPage:n.page,observerId:s.observerId}})};let q=n.src.includes("cocos");const H=a=>{G(),m.emit(se.IframeLoad,a),m.on(u.Ready,()=>{var d,o;(d=n.lastEvent)!=null&&d.payload&&p((o=n.lastEvent)==null?void 0:o.payload)}),q&&(setTimeout(()=>{p({kind:u.RoomStateChanged,payload:N(1,n.maxPage,n.displaySceneDir)})},500),q=!1),f.removeEventListener("load",H)};c.addEventListener(f,"load",H);let ie=0;const ne=()=>{ie++<3&&(f.src=n.src)};c.addEventListener(f,"error",ne),f.src=n.src,c.add(()=>t.mobxUtils.autorun(()=>{p({kind:u.AttributesUpdate,payload:L(n.state)})})),c.add(()=>t.mobxUtils.autorun(()=>{f.src=n.src})),c.add(()=>t.mobxUtils.autorun(()=>{p({kind:u.RoomStateChanged,payload:N(n.page,n.maxPage,n.displaySceneDir)})}));const J={emitter:m,postMessage:p,context:t};return m.emit(u.StartCreate),m.emit(u.OnCreate,J),i&&c.add(()=>{const a=d=>{d.memberState&&x(W(d.memberState.currentApplianceName))};return i.callbacks.on("onRoomStateChanged",a),()=>i.callbacks.off("onRoomStateChanged",a)}),c.addEventListener(window,"message",a=>{if(a.source!==f.contentWindow)return;const d=a.data;switch(z("[IframeBridge] received",d.kind,d.payload),d.kind){case u.SetAttributes:{t.updateAttributes(["state"],D(D({},n.state),d.payload));break}case u.RegisterMagixEvent:{const o=k=>{k.authorId!==s.observerId&&p({kind:u.ReceiveMagixEvent,payload:k})},h=d.payload;v.set(h,o),s.addMagixEventListener(h,o);break}case u.RemoveMagixEvent:{const o=d.payload,h=v.get(o);s.removeMagixEventListener(o,h);break}case u.DispatchMagixEvent:{const o=d.payload;P(o.event,o.payload);break}case u.RemoveAllMagixEvent:{B();break}case u.NextPage:{if(t.getIsWritable()&&i){const o=Me(n.page,n.maxPage);if(o===n.page)break;t.setScenePath([n.displaySceneDir,o].join("/")),t.updateAttributes(["page"],o),P(u.NextPage,{})}break}case u.PrevPage:{if(t.getIsWritable()&&i){const o=Ee(n.page);if(o===n.page)break;t.setScenePath([n.displaySceneDir,o].join("/")),t.updateAttributes(["page"],o),P(u.PrevPage,{})}break}case u.SetPage:{const o=Number(d.payload)||0;if(t.getIsWritable()&&i)if(!o)i.removeScenes(n.displaySceneDir);else{const h=i.entireScenes()[n.displaySceneDir];(!h||h.length!==o)&&(i.removeScenes(n.displaySceneDir),i.putScenes(n.displaySceneDir,re(o))),t.setScenePath(`${n.displaySceneDir}/1`),t.updateAttributes(["maxPage"],o)}break}case u.PageTo:{const o=d.payload;if(t.getIsWritable()&&i){if(!Number.isSafeInteger(o)||o<=0)break;t.setScenePath(`${n.displaySceneDir}/${o}`),t.updateAttributes(["page"],o),P(u.PageTo,o-1)}break}case u.SDKCreate:{G();break}case u.GetAttributes:{p({kind:u.GetAttributes,payload:L(n.state)});break}default:console.warn(`[IframeBridge]: unknown event kind "${d.kind}"`)}}),t.emitter.on("destroy",()=>{console.log("[IframeBridge]: destroy"),m.emit(u.Destroy),c.flushAll(),B(),f.remove()}),J}};exports.default=Ce;
//# sourceMappingURL=main.cjs.js.map
